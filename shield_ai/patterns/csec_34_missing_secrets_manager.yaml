pattern_id: csec_34_missing_secrets_manager
name: "Missing AWS Secrets Manager Integration"
category: secrets_management
severity: high
description: |
  Detects Django settings files that store secrets in environment variables or hardcoded
  instead of using AWS Secrets Manager for centralized secret management.

  Without AWS Secrets Manager:
  - Secrets stored in .env files (can be committed to git)
  - No secret rotation capability
  - Secrets visible in process listings (ps aux)
  - No audit trail for secret access
  - Secrets shared insecurely (Slack, email)
  - No encryption at rest (depends on disk encryption only)

  AWS Secrets Manager provides:
  - Centralized secret storage with KMS encryption
  - Automatic secret rotation
  - Audit trail via CloudTrail
  - Version control and rollback
  - Secure sharing via IAM permissions

jira_reference:
  ticket: CSEC-34
  epic: CSEC-8
  project: "Coco TestAI Security Remediation"

detection:
  python:
    # Pattern 1: Direct SECRET_KEY from os.environ
    - pattern: "SECRET_KEY\\s*=\\s*os\\.environ\\.get\\(['\"]SECRET_KEY['\"]"
      description: "Django SECRET_KEY read directly from environment"
      example: "SECRET_KEY = os.environ.get('SECRET_KEY')"
      severity: high

    # Pattern 2: Database password from os.environ
    - pattern: "['\"]PASSWORD['\"]\\s*:\\s*os\\.environ\\.get\\(['\"](?:DATABASE_PASSWORD|DB_PASSWORD)['\"]"
      description: "Database password read from environment variable"
      example: "'PASSWORD': os.environ.get('DATABASE_PASSWORD')"
      severity: high

    # Pattern 3: AWS credentials from os.environ
    - pattern: "AWS_SECRET_ACCESS_KEY\\s*=\\s*os\\.environ\\.get\\(['\"]AWS_SECRET_ACCESS_KEY['\"]"
      description: "AWS secret access key read from environment"
      example: "AWS_SECRET_ACCESS_KEY = os.environ.get('AWS_SECRET_ACCESS_KEY')"
      severity: high

    # Pattern 4: Missing get_secret() import
    - pattern: "^(?!.*from\\s+(?:interpreter\\.)?utils\\.secrets\\s+import)"
      description: "Settings file without AWS Secrets Manager utility import"
      example: "# No import from utils.secrets"
      severity: medium

    # Pattern 5: API keys from os.environ
    - pattern: "(?:API_KEY|STRIPE_SECRET|SENDGRID_API_KEY)\\s*=\\s*os\\.environ\\.get"
      description: "API keys read directly from environment variables"
      example: "STRIPE_SECRET = os.environ.get('STRIPE_SECRET')"
      severity: medium

    # Pattern 6: Hardcoded secrets (anti-pattern detection)
    - pattern: "(?:SECRET_KEY|PASSWORD|API_KEY)\\s*=\\s*['\"][^'\"]{20,}['\"]"
      description: "Potentially hardcoded secret detected"
      example: "SECRET_KEY = 'django-insecure-hardcoded-key-12345'"
      severity: critical

file_patterns:
  - "**/*settings*.py"
  - "**/config.py"
  - "**/config/*.py"
  - "**/settings/*.py"

risk_assessment:
  impact: high
  exploitability: medium
  affected_scope: secret_management
  attack_vectors:
    - "Hardcoded secrets in version control"
    - "Secrets exposed in environment variables"
    - "No secret rotation capability"
    - "Secrets visible in process listings"
    - "No audit trail for secret access"
    - "Insecure secret sharing practices"
    - "Secrets in log files and error messages"

  labels:
    - P1-High
    - security
    - backend
    - infrastructure
    - wrapper

  vulnerabilities:
    - name: "Secret Exposure in Version Control"
      description: ".env files or hardcoded secrets can be committed to git"
      cvss: "HIGH"
      cwe: "CWE-798"

    - name: "No Secret Rotation"
      description: "Secrets remain static, increasing compromise risk over time"
      cvss: "MEDIUM"
      cwe: "CWE-798"

    - name: "Process Listing Exposure"
      description: "Environment variables visible in ps aux or /proc filesystem"
      cvss: "MEDIUM"
      cwe: "CWE-200"

    - name: "No Audit Trail"
      description: "Cannot track who accessed secrets or when"
      cvss: "MEDIUM"
      cwe: "CWE-778"

fix_strategy:
  approach: wrapper
  breaking_change: false
  description: |
    Create get_secret() wrapper utility with AWS Secrets Manager integration.
    Maintains backward compatibility with environment variables for local development.

    Implementation steps:
    1. Create utils/secrets.py with SecretsManagerClient and get_secret()
    2. Add caching (LRU) to reduce AWS API calls
    3. Implement graceful fallback to environment variables
    4. Update settings.py to use get_secret() for all secrets
    5. Create AWS Secrets Manager entries for production secrets
    6. Configure IAM policies for least-privilege access
    7. Set up automatic secret rotation (optional)

  phased_rollout:
    phase_1:
      description: "Deploy get_secret() utility with USE_AWS_SECRETS=false"
      duration: "1 week"
      testing: "Verify backward compatibility, no breakage"

    phase_2:
      description: "Test AWS Secrets Manager in staging"
      duration: "1 week"
      testing: "Enable USE_AWS_SECRETS=true, verify integration"

    phase_3:
      description: "Production rollout"
      duration: "1+ weeks"
      testing: "Monitor CloudWatch, verify secret retrieval"

acceptance_criteria:
  - "utils/secrets.py created with get_secret() and get_secret_dict()"
  - "LRU caching implemented with 5-minute TTL"
  - "Graceful fallback to environment variables"
  - "settings.py updated to use get_secret() for SECRET_KEY"
  - "settings.py updated to use get_secret_dict() for database credentials"
  - "AWS Secrets Manager entries created for all secrets"
  - "IAM policy configured with least privilege (GetSecretValue only)"
  - ".env.example updated with USE_AWS_SECRETS documentation"
  - "Unit tests with >90% coverage"
  - "Integration tests for AWS SM retrieval (optional)"
  - "No breaking changes to local development workflow"

secrets_to_migrate:
  django:
    - name: "SECRET_KEY"
      aws_secret_name: "django-secret-key"
      type: "string"
      rotation: "manual"

  database:
    - name: "DATABASE_CREDENTIALS"
      aws_secret_name: "database-credentials"
      type: "json"
      fields: ["database", "username", "password", "host", "port"]
      rotation: "30 days"

  aws:
    - name: "AWS_ACCESS_KEY_ID"
      aws_secret_name: "aws-access-key-id"
      type: "string"
      rotation: "90 days"

    - name: "AWS_SECRET_ACCESS_KEY"
      aws_secret_name: "aws-secret-access-key"
      type: "string"
      rotation: "90 days"

  api_keys:
    - name: "STRIPE_SECRET_KEY"
      aws_secret_name: "stripe-secret-key"
      type: "string"
      rotation: "90 days"
      optional: true

    - name: "SENDGRID_API_KEY"
      aws_secret_name: "sendgrid-api-key"
      type: "string"
      rotation: "90 days"
      optional: true

estimated_effort:
  task_8_1_1: "4 hours - Create get_secret() utility with caching"
  task_8_1_2: "3 hours - Update settings.py to use get_secret()"
  task_8_1_3: "3 hours - Create AWS Secrets Manager entries"
  task_8_1_4: "0.5 hours - Update .env.example documentation"
  task_8_1_5: "2 hours - Write unit and integration tests"
  task_8_1_6: "2 hours - Set up secret rotation schedule"
  total: "14.5 hours"

testing:
  unit_tests:
    - "Test get_secret() with environment variable fallback"
    - "Test get_secret() with AWS Secrets Manager (mocked)"
    - "Test get_secret_dict() for JSON secrets"
    - "Test cache functionality (LRU, TTL)"
    - "Test error handling (secret not found, access denied)"
    - "Test graceful degradation (boto3 not installed)"

  integration_tests:
    - "End-to-end AWS Secrets Manager retrieval (staging)"
    - "Database connection with AWS-retrieved credentials"
    - "Secret rotation simulation"
    - "Cache invalidation after rotation"

  verification_commands:
    - "python manage.py check (verify no errors)"
    - "python manage.py shell -c 'from utils.secrets import get_secret; print(get_secret(\"test\"))'"
    - "aws secretsmanager get-secret-value --secret-id django-secret-key"
    - "curl http://localhost:8000/health (verify app starts)"

compliance:
  soc2:
    - "Centralized secret management"
    - "Audit trail for secret access (CloudTrail)"

  pci_dss:
    - "PCI DSS 3.4 - Encryption of stored secrets (KMS)"

  nist:
    - "NIST 800-53 SC-12 - Cryptographic key management"

  hipaa:
    - "HIPAA ยง164.312(a)(2)(iv) - Encryption and decryption"

  iso27001:
    - "ISO 27001 A.10.1.2 - Key management"

  gdpr:
    - "GDPR Article 32 - Encryption of personal data"

cost_analysis:
  aws_secrets_manager:
    storage: "$0.40 per secret per month"
    api_calls: "$0.05 per 10,000 API calls"
    secrets_count: 4
    estimated_monthly_cost: "$2.00"
    annual_cost: "$24.00"

  optimization:
    caching: "Reduces API calls by >95%"
    free_tier: "First 30 days free for new secrets"

references:
  - "https://aws.amazon.com/secrets-manager/"
  - "https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/secretsmanager.html"
  - "https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets.html"
  - "https://owasp.org/www-community/vulnerabilities/Use_of_hard-coded_password"
  - "https://cwe.mitre.org/data/definitions/798.html"
