pattern_id: csec_18_hardcoded_secret
name: "Hardcoded Secret Key with Fallback"
category: secrets_management
severity: critical
description: |
  Detects secret keys, passwords, or tokens that have hardcoded fallback values
  when environment variables are not set. This is a security risk as the fallback
  value may be exposed in version control or used in production.

jira_reference:
  ticket: CSEC-18
  epic: CSEC-1
  project: "Coco TestAI Security Remediation"

detection:
  # Python patterns only (for Django/Flask/FastAPI)
  python:
    - pattern: '(\w+(?:_KEY|_SECRET|_PASSWORD|_TOKEN))\s*=\s*os\.environ\.get\(["\']([^"\']+)["\']\s*,\s*["\']([^"\']+)["\']\)'
      description: "os.environ.get() with string fallback"
      example: "SECRET_KEY = os.environ.get('SECRET_KEY', 'insecure-default')"

    - pattern: '(\w+(?:_KEY|_SECRET|_PASSWORD|_TOKEN))\s*=\s*os\.getenv\(["\']([^"\']+)["\']\s*,\s*["\']([^"\']+)["\']\)'
      description: "os.getenv() with string fallback"
      example: "API_KEY = os.getenv('API_KEY', 'default-key')"

    - pattern: '(\w+(?:_KEY|_SECRET|_PASSWORD|_TOKEN))\s*=\s*os\.environ\.get\(["\']([^"\']+)["\']\)\s*or\s*["\']([^"\']+)["\']'
      description: "os.environ.get() with or fallback"
      example: "SECRET_KEY = os.environ.get('SECRET_KEY') or 'default'"

file_patterns:
  - "**/*settings*.py"      # Django settings
  - "**/*config*.py"        # Flask/FastAPI config

risk_assessment:
  impact: high
  exploitability: critical
  affected_scope: entire_application
  labels:
    - P0-Critical
    - security
    - backend
    - extension-launch

fix_strategy:
  approach: phased_migration
  breaking_change: false
  phases:
    - name: warning
      duration_days: 30
      description: "Add deprecation warnings while keeping fallback functional"

    - name: enforcement
      duration_days: null
      description: "Remove fallback and enforce environment variable requirement"
      trigger: manual_approval

acceptance_criteria:
  - "Application raises error on startup if env var is missing (Phase 2)"
  - "No hardcoded key exists anywhere in configuration"
  - ".env.example files include placeholder with generation instructions"
  - "Existing developer environments continue to work (Phase 1)"

estimated_effort:
  detection: "5 minutes"
  fix_application: "30 minutes per codebase"
  testing: "1 hour"
  total: "2 hours per codebase"
