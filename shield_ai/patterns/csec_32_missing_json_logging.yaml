pattern_id: csec_32_missing_json_logging
name: "Missing Structured JSON Logging"
category: audit_logging
severity: medium
description: |
  Detects Django applications using plain text logging instead of structured
  JSON logging. Structured JSON logs are essential for:
  - Log aggregation systems (CloudWatch, ELK, Splunk)
  - Security event correlation and analysis
  - Compliance audit trails
  - Automated alerting and monitoring
  - Incident response and forensics

  Plain text logs are difficult to parse, search, and analyze at scale.

jira_reference:
  ticket: CSEC-32
  epic: CSEC-6
  project: "Coco TestAI Security Remediation"

detection:
  python:
    # Pattern 1: LOGGING config with plain text formatters
    - pattern: "'formatters'\\s*:\\s*\\{[^}]*'format'\\s*:\\s*['\"]"
      description: "LOGGING uses plain text format strings instead of JSON"
      example: |
        LOGGING = {
            'formatters': {
                'verbose': {
                    'format': '{levelname} {asctime} {module} {message}',
                }
            }
        }
      severity: medium
      negative_lookahead: "(?:json|JSON|JsonFormatter|structlog)"

    # Pattern 2: Missing python-json-logger or structlog
    - pattern: "^LOGGING\\s*=\\s*\\{"
      description: "LOGGING configuration without JSON formatter library"
      example: |
        LOGGING = {
            'version': 1,
            'formatters': {...},
        }
      severity: medium
      context_check: "no_json_logging_library"

    # Pattern 3: No LOGGING configuration at all
    - pattern: "^(?!.*LOGGING)"
      description: "No LOGGING configuration in settings (using Django defaults)"
      example: "# Settings file without LOGGING dict"
      severity: low
      context_check: "no_logging_config"

file_patterns:
  - "**/settings.py"
  - "**/settings/*.py"
  - "**/*settings*.py"
  - "**/logging_config.py"

risk_assessment:
  impact: medium_high
  exploitability: low
  affected_scope: logging_and_monitoring
  operational_risks:
    - "Difficult log parsing and analysis"
    - "Slow security incident investigation"
    - "Compliance audit challenges"
    - "Cannot easily integrate with SIEM systems"
    - "Manual log analysis time-consuming"
    - "Missed security events in production"
  security_implications:
    - "Harder to detect security incidents"
    - "Difficult to correlate attack patterns"
    - "Audit trail gaps"
    - "Forensic analysis challenges"
  compliance_gaps:
    - "PCI DSS Requirement 10 - Audit logging"
    - "SOC 2 - Logging and monitoring controls"
    - "GDPR Article 30 - Records of processing"
    - "HIPAA - Audit controls"
  labels:
    - P1-High
    - logging
    - security
    - backend
    - extension-launch
    - wrapper

fix_strategy:
  approach: configuration_addition
  breaking_change: false
  description: |
    Add structured JSON logging configuration to Django settings using either:
    1. python-json-logger (lightweight, recommended for most cases)
    2. structlog (advanced, rich features, better for complex apps)

    The fix adds JSON formatters, configures handlers, and includes middleware
    to add contextual information (request_id, user_id, ip_address) to logs.

    Non-breaking: Existing logging calls continue to work, just formatted as JSON.

  implementation_options:
    - option: json_logger
      name: "python-json-logger"
      pros: "Lightweight, simple config, Django-compatible, minimal overhead"
      cons: "Basic features only"
      recommended: true

    - option: structlog
      name: "structlog + django-structlog"
      pros: "Rich features, context binding, processors, better performance"
      cons: "More complex configuration, additional dependency"

  key_features:
    - "JSON formatted log output"
    - "Contextual logging (request_id, user_id, ip_address)"
    - "Timestamp in ISO 8601 format"
    - "Structured fields for easy parsing"
    - "CloudWatch/ELK/Splunk compatible"
    - "Request correlation via request_id"
    - "Security event tracking"

acceptance_criteria:
  - "All logs output in JSON format"
  - "Logs include timestamp, level, logger, message fields"
  - "Request logs include request_id, user_id, path, method, status_code"
  - "Logs parseable by CloudWatch/ELK/Splunk"
  - "Existing logging calls work without modification"
  - "Middleware adds request context automatically"
  - "No breaking changes to application code"

estimated_effort:
  detection: "30 minutes"
  fix_application: "2 hours (configuration and middleware)"
  testing: "1 hour (verify JSON output and log aggregation)"
  total: "3.5 hours per codebase"

log_format_example:
  json_output: |
    {
      "timestamp": "2024-01-15T10:30:45.123Z",
      "level": "INFO",
      "logger": "django.request",
      "message": "User login successful",
      "request_id": "abc123-def456",
      "user_id": 42,
      "username": "john.doe",
      "ip_address": "192.168.1.100",
      "path": "/api/auth/login",
      "method": "POST",
      "status_code": 200,
      "duration_ms": 145,
      "user_agent": "Mozilla/5.0..."
    }

  plain_text_output: |
    2024-01-15 10:30:45,123 INFO django.request User login successful

required_fields:
  core:
    - "timestamp (ISO 8601 with timezone)"
    - "level (DEBUG, INFO, WARNING, ERROR, CRITICAL)"
    - "logger (logger name)"
    - "message (human-readable message)"
  request_context:
    - "request_id (unique identifier for request tracing)"
    - "user_id (authenticated user ID)"
    - "username (authenticated username)"
    - "ip_address (client IP address)"
  http_details:
    - "path (request path)"
    - "method (HTTP method)"
    - "status_code (response status)"
    - "duration_ms (request duration)"
  optional:
    - "session_id"
    - "tenant_id (for multi-tenant apps)"
    - "trace_id (for distributed tracing)"
    - "user_agent"
    - "referer"

compliance:
  - standard: "PCI DSS"
    requirement: "Requirement 10"
    description: "Track and monitor all access to network resources and cardholder data with structured audit logs"

  - standard: "SOC 2"
    requirement: "CC7.2"
    description: "System operations log data to enable monitoring for security incidents"

  - standard: "GDPR"
    requirement: "Article 30"
    description: "Records of processing activities must be maintained"

  - standard: "HIPAA"
    requirement: "ยง164.312(b)"
    description: "Audit controls to record and examine activity in systems with ePHI"

  - standard: "ISO 27001"
    requirement: "A.12.4.1"
    description: "Event logging - Record events in event logs"

integration_benefits:
  cloudwatch:
    - "Automatic JSON parsing"
    - "CloudWatch Insights queries"
    - "Metric filters on structured fields"
    - "Automated alerting"

  elasticsearch_elk:
    - "Direct JSON ingestion"
    - "Kibana dashboard creation"
    - "Structured field indexing"
    - "Advanced search queries"

  splunk:
    - "Automatic field extraction"
    - "Dashboard and visualization"
    - "Correlation searches"
    - "Real-time alerting"

  datadog:
    - "Structured log facets"
    - "Log analytics"
    - "APM correlation"
    - "Custom metrics from logs"

security_use_cases:
  - "Detect brute force attacks (multiple failed login attempts)"
  - "Identify privilege escalation attempts"
  - "Track data access patterns"
  - "Correlate security events across services"
  - "Audit trail for compliance"
  - "Forensic analysis of incidents"
  - "Automated threat detection"

references:
  - "https://github.com/madzak/python-json-logger"
  - "https://www.structlog.org/"
  - "https://django-structlog.readthedocs.io/"
  - "https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/AnalyzingLogData.html"
  - "https://www.elastic.co/guide/en/ecs/current/index.html"
