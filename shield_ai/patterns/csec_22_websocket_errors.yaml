pattern_id: csec_22_websocket_errors
name: "Unsanitized WebSocket Error Messages"
category: information_disclosure
severity: critical
description: |
  Detects WebSocket error handlers that send raw exception messages (str(e)) to clients.
  This exposes sensitive information including:
  - Internal file paths and stack traces
  - Database schema and error details
  - Configuration information
  - Library versions and dependencies
  - Sensitive business logic

  Error messages should be sanitized and generic for clients, while full details
  are logged server-side for debugging.

jira_reference:
  ticket: CSEC-22
  epic: CSEC-2
  project: "Coco TestAI Security Remediation"

detection:
  python:
    # Pattern 1: Direct str(e) in WebSocket send/text_data
    - pattern: "(await\\s+self\\.send)\\([^)]*text_data\\s*=\\s*json\\.dumps\\([^)]*['\"]error['\"]\\s*:\\s*str\\((\\w+)\\)"
      description: "WebSocket sends raw exception message via text_data"
      example: "await self.send(text_data=json.dumps({'error': str(e)}))"
      severity: critical

    # Pattern 2: str(e) in self.send without text_data keyword
    - pattern: "(await\\s+self\\.send)\\(json\\.dumps\\([^)]*['\"]error['\"]\\s*:\\s*str\\((\\w+)\\)"
      description: "WebSocket sends raw exception without text_data keyword"
      example: "await self.send(json.dumps({'error': str(e)})))"
      severity: critical

    # Pattern 3: Direct dictionary with str(e) in send
    - pattern: "(await\\s+self\\.send)\\([^)]*['\"]error['\"]\\s*:\\s*str\\((\\w+)\\)"
      description: "WebSocket sends raw exception in dictionary"
      example: "await self.send({'error': str(e)})"
      severity: critical

    # Pattern 4: f-string with exception in WebSocket send
    - pattern: "(await\\s+self\\.send)\\([^)]*f['\"][^'\"]*\\{(\\w+)\\}"
      description: "WebSocket sends exception via f-string"
      example: "await self.send(f'Error: {e}')"
      severity: high

    # Pattern 5: String concatenation with exception
    - pattern: "(await\\s+self\\.send)\\([^)]*['\"][^'\"]*['\"]\\s*\\+\\s*str\\((\\w+)\\)"
      description: "WebSocket sends exception via string concatenation"
      example: "await self.send('Error: ' + str(e))"
      severity: high

file_patterns:
  - "**/consumers.py"
  - "**/websocket*.py"
  - "**/channels/*.py"
  - "**/*consumer*.py"

risk_assessment:
  impact: critical
  exploitability: high
  affected_scope: websocket_communication
  attack_vectors:
    - "Information disclosure via error messages"
    - "Path traversal information leakage"
    - "Database schema enumeration"
    - "Technology stack fingerprinting"
    - "Sensitive data exposure in exceptions"
  labels:
    - P0-Critical
    - security
    - backend
    - extension-launch
    - information-disclosure

fix_strategy:
  approach: wrapper
  breaking_change: false
  description: |
    Wrap exception handlers to:
    1. Log full exception details server-side (with traceback)
    2. Return generic, user-friendly error messages to clients
    3. Add error correlation IDs for debugging
    4. Maintain observability without exposing internals

acceptance_criteria:
  - "All 8 instances in consumers.py replaced with generic messages"
  - "Full exceptions logged server-side with logger.error(..., exc_info=True)"
  - "No stack traces, paths, or internal details sent to WebSocket clients"
  - "Generic error messages are user-friendly and actionable"
  - "Server logs allow correlation between client errors and server exceptions"

estimated_effort:
  detection: "10 minutes"
  fix_application: "2 hours for 8 instances"
  testing: "1 hour"
  total: "3 hours"

references:
  - "https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure"
  - "https://owasp.org/www-community/Improper_Error_Handling"
  - "https://cheatsheetseries.owasp.org/cheatsheets/Error_Handling_Cheat_Sheet.html"
  - "https://cwe.mitre.org/data/definitions/209.html"
