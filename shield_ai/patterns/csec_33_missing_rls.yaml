pattern_id: csec_33_missing_rls
name: "Missing PostgreSQL Row-Level Security (RLS)"
description: |
  Detects Django projects with multi-tenant models that lack PostgreSQL
  Row-Level Security (RLS) implementation. RLS is critical for preventing
  cross-tenant data leaks by enforcing tenant isolation at the database level.

severity: critical
category: database_security
language: python
frameworks:
  - django

cwe:
  - CWE-285  # Improper Authorization
  - CWE-639  # Authorization Bypass Through User-Controlled Key
  - CWE-566  # Authorization Bypass Through User-Controlled SQL Primary Key

owasp:
  - A01:2021  # Broken Access Control
  - A03:2021  # Injection

tags:
  - multi-tenancy
  - database-security
  - row-level-security
  - tenant-isolation
  - postgresql
  - authorization

file_patterns:
  - "**/models.py"
  - "**/*models*.py"
  - "**/settings.py"
  - "**/*settings*.py"
  - "**/middleware.py"
  - "**/*middleware*.py"
  - "**/migrations/*.py"

detection:
  python:
    # Detection 1: Models with tenant_id field but no RLS mention in migrations
    - pattern: 'class\s+\w+\(models\.Model\)[\s\S]*?tenant_id\s*=\s*models\.'
      description: "Model with tenant_id field (may need RLS)"
      severity: critical

    # Detection 2: ForeignKey to Tenant/Organization model
    - pattern: 'class\s+\w+\(models\.Model\)[\s\S]*?(tenant|organization)\s*=\s*models\.ForeignKey'
      description: "Model with tenant/organization FK (may need RLS)"
      severity: critical

    # Detection 3: Settings without RLS middleware
    - pattern: 'MIDDLEWARE\s*=\s*\[[\s\S]*?\]'
      description: "MIDDLEWARE without RLS tenant context middleware"
      severity: high
      requires_absence: 'TenantRLSMiddleware|RowLevelSecurityMiddleware|SetTenantMiddleware'

    # Detection 4: Database settings without RLS configuration
    - pattern: 'DATABASES\s*=\s*\{[\s\S]*?\}'
      description: "DATABASES configuration (check for RLS setup)"
      severity: medium

    # Detection 5: Migration files without RLS SQL
    - pattern: 'class\s+Migration\(migrations\.Migration\):'
      description: "Migration file (check if RLS policies are created)"
      severity: low
      file_constraint: "migrations/"

metadata:
  impact: |
    Without Row-Level Security:
    - Application bugs can leak data across tenants
    - SQL injection bypasses application-level filtering
    - Direct database access risks cross-tenant exposure
    - ORM bugs expose all tenant data
    - No defense-in-depth for multi-tenancy

  business_risk: |
    - GDPR violations (data breach across tenants)
    - Contract breaches (SaaS isolation requirements)
    - Loss of customer trust
    - Regulatory fines
    - Reputation damage

  compliance:
    - "SOC 2 Type II: Logical Access Controls"
    - "ISO 27001: A.9.4.1 - Information access restriction"
    - "GDPR Article 32: Security of processing"
    - "HIPAA ยง164.312(a)(1): Access controls"
    - "PCI DSS Requirement 7: Restrict access to cardholder data"

jira_reference:
  ticket: CSEC-33
  epic: CSEC-7
  project: Coco TestAI Security Remediation

fix_strategy:
  approach: database_rls_implementation
  breaking_change: false
  description: |
    Implement PostgreSQL Row-Level Security (RLS) for tenant isolation:

    1. Enable RLS on all tenant-scoped tables
    2. Create RLS policies to filter by current_tenant_id
    3. Add middleware to set app.current_tenant_id on each request
    4. Configure migration/superuser to bypass RLS
    5. Add integration tests for cross-tenant isolation

    This is a non-breaking addition that provides defense-in-depth security.

  phases:
    - name: discovery
      duration_days: 0
      description: "Identify all models with tenant FK"

    - name: migration_creation
      duration_days: 1
      description: "Create migration to enable RLS and policies"

    - name: middleware_implementation
      duration_days: 1
      description: "Create and configure tenant context middleware"

    - name: user_configuration
      duration_days: 0
      description: "Configure migration user to bypass RLS"

    - name: testing
      duration_days: 2
      description: "Write and run integration tests"

    - name: validation
      duration_days: 1
      description: "Verify cross-tenant isolation in production-like environment"

remediation:
  automated: false  # Requires careful migration planning
  manual_steps: |
    1. Review all models with tenant_id/organization FK
    2. Create Django migration with raw SQL to enable RLS
    3. Create RLS policies for each tenant-scoped table
    4. Implement TenantRLSMiddleware to set current_tenant_id
    5. Add middleware to MIDDLEWARE settings
    6. Configure database users:
       - Migration user: BYPASSRLS privilege
       - Application user: No BYPASSRLS (RLS enforced)
    7. Write integration tests to verify:
       - Tenant A cannot access Tenant B data
       - Middleware sets tenant context correctly
       - Migrations run successfully with bypass
    8. Test WebSocket consumers with tenant context
    9. Deploy with phased rollout (read-only first, then enforce)

  fix_template: csec_33_python.py

  testing_approach: |
    1. Unit tests for middleware
    2. Integration tests for RLS policies
    3. Cross-tenant isolation tests
    4. WebSocket consumer tests
    5. Migration rollback tests
    6. Performance tests (RLS overhead)

examples:
  vulnerable_code: |
    # models.py - Missing RLS
    class Document(models.Model):
        tenant = models.ForeignKey(Tenant, on_delete=models.CASCADE)
        title = models.CharField(max_length=200)
        content = models.TextField()

    # views.py - Application-level filtering (can be bypassed)
    def get_documents(request):
        tenant_id = request.user.tenant_id
        # If tenant_id is manipulated, can access other tenant data!
        return Document.objects.filter(tenant_id=tenant_id)

  secure_code: |
    # Migration: enable_rls_on_documents.py
    operations = [
        migrations.RunSQL('''
            ALTER TABLE app_document ENABLE ROW LEVEL SECURITY;

            CREATE POLICY tenant_isolation_policy ON app_document
            USING (tenant_id = current_setting('app.current_tenant_id')::int);
        ''', reverse_sql='''
            DROP POLICY IF EXISTS tenant_isolation_policy ON app_document;
            ALTER TABLE app_document DISABLE ROW LEVEL SECURITY;
        ''')
    ]

    # middleware/tenant_rls.py
    class TenantRLSMiddleware:
        def __call__(self, request):
            if hasattr(request.user, 'tenant_id'):
                with connection.cursor() as cursor:
                    cursor.execute(
                        "SET LOCAL app.current_tenant_id = %s",
                        [request.user.tenant_id]
                    )
            return self.get_response(request)

    # views.py - RLS automatically enforces tenant filtering
    def get_documents(request):
        # RLS ensures only current tenant's documents are returned
        # Even if application code has bugs!
        return Document.objects.all()

references:
  - https://www.postgresql.org/docs/current/ddl-rowsecurity.html
  - https://aws.amazon.com/blogs/database/multi-tenant-data-isolation-with-postgresql-row-level-security/
  - https://www.citusdata.com/blog/2018/08/01/securing-multi-tenant-apps-with-postgres-row-level-security/
  - https://docs.djangoproject.com/en/stable/ref/databases/#postgresql-notes

notes: |
  IMPORTANT CONSIDERATIONS:

  1. Database Engine: PostgreSQL 9.5+ required for RLS
  2. Performance: RLS adds minimal overhead (~1-5% query time)
  3. Migrations: Must run with BYPASSRLS user
  4. Testing: Use separate test databases per tenant for isolation tests
  5. Monitoring: Track RLS policy violations in logs

  DEPLOYMENT CHECKLIST:
  - [ ] PostgreSQL version >= 9.5
  - [ ] Migration user has BYPASSRLS privilege
  - [ ] Application user does NOT have BYPASSRLS
  - [ ] All tenant-scoped tables have RLS enabled
  - [ ] Middleware is first in MIDDLEWARE list (before auth)
  - [ ] Integration tests pass for cross-tenant isolation
  - [ ] WebSocket consumers set tenant context
  - [ ] Monitoring alerts on RLS policy violations
