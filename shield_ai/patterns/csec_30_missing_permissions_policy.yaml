pattern_id: csec_30_missing_permissions_policy
name: "Missing Permissions-Policy Header"
category: security_headers
severity: medium
description: |
  Detects Django projects without Permissions-Policy header configuration.
  The Permissions-Policy header (formerly Feature-Policy) controls which browser
  features and APIs can be used in the browser. Missing this header allows:
  - Unauthorized camera/microphone access
  - Geolocation tracking without consent
  - Autoplay of media
  - Payment APIs without user approval
  - Other potentially privacy-invasive browser features

  A properly configured Permissions-Policy header should restrict features that
  the application doesn't need, following the principle of least privilege.

jira_reference:
  ticket: CSEC-30
  epic: CSEC-5
  project: "Coco TestAI Security Remediation"

detection:
  # Python patterns for missing Permissions-Policy
  python:
    # Check 1: Missing permissions_policy middleware in MIDDLEWARE
    - pattern: 'MIDDLEWARE\s*=\s*\[[\s\S]*?\]'
      description: "MIDDLEWARE without permissions_policy middleware"
      example: |
        MIDDLEWARE = [
            'django.middleware.security.SecurityMiddleware',
            # Missing permissions_policy middleware
        ]

    # Check 2: No custom middleware files for permissions policy
    - pattern: 'class\s+\w*SecurityMiddleware\w*'
      description: "Custom security middleware without Permissions-Policy"
      example: |
        class CustomSecurityMiddleware:
            # Missing Permissions-Policy implementation

file_patterns:
  - "**/*settings*.py"
  - "**/settings/*.py"
  - "**/middleware.py"
  - "**/middleware/*.py"
  - "**/*middleware*.py"

risk_assessment:
  impact: medium
  exploitability: medium
  affected_scope: privacy_security
  labels:
    - P1-High
    - security
    - backend
    - extension-launch
    - wrapper

  risks:
    - "Unauthorized camera/microphone access via embedded iframes"
    - "Geolocation tracking without user consent"
    - "Autoplaying media draining battery/bandwidth"
    - "Unauthorized payment requests"
    - "Fullscreen API abuse for phishing"
    - "USB device access without permission"
    - "Accelerometer/gyroscope data leakage"

fix_strategy:
  approach: middleware_addition
  breaking_change: false
  description: |
    Add custom Django middleware that injects Permissions-Policy header
    into all HTTP responses. This is a non-breaking addition that restricts
    browser features based on application needs.

  phases:
    - name: detection
      duration_days: 0
      description: "Scan for missing Permissions-Policy configuration"

    - name: middleware_creation
      duration_days: 0
      description: "Create custom permissions_policy middleware"

    - name: configuration
      duration_days: 0
      description: "Add middleware to MIDDLEWARE list"

    - name: testing
      duration_days: 1
      description: "Verify header appears in responses"

permissions_policy_directives:
  recommended_restrictive:
    # Highly sensitive features - deny by default
    camera: "()"                    # No camera access
    microphone: "()"                # No microphone access
    geolocation: "()"               # No geolocation access
    payment: "()"                   # No payment APIs
    usb: "()"                       # No USB access
    magnetometer: "()"              # No magnetometer access
    gyroscope: "()"                 # No gyroscope access
    accelerometer: "()"             # No accelerometer access

  recommended_permissive:
    # Less sensitive - allow for same origin
    fullscreen: "(self)"            # Allow fullscreen for same origin
    picture-in-picture: "(self)"    # Allow PiP for same origin
    display-capture: "(self)"       # Allow screen sharing for same origin
    clipboard-read: "(self)"        # Allow clipboard read for same origin
    clipboard-write: "(self)"       # Allow clipboard write for same origin

  application_specific:
    # Features that depend on application needs
    autoplay: "(self)"              # Control media autoplay
    sync-xhr: "()"                  # Disable synchronous XHR (deprecated)
    encrypted-media: "(self)"       # DRM content
    midi: "()"                      # MIDI device access

middleware_configuration:
  file_path: "middleware/permissions_policy.py"
  class_name: "PermissionsPolicyMiddleware"
  middleware_position: "after SecurityMiddleware"

acceptance_criteria:
  - "Middleware file created at middleware/permissions_policy.py"
  - "Middleware added to MIDDLEWARE in settings.py"
  - "Permissions-Policy header appears in all HTTP responses"
  - "Camera and microphone denied by default"
  - "Geolocation denied by default"
  - "Payment APIs denied by default"
  - "Header verified with browser dev tools"
  - "No breaking changes to existing functionality"

estimated_effort:
  detection: "10 minutes"
  middleware_creation: "1 hour"
  settings_update: "30 minutes"
  testing: "30 minutes"
  documentation: "30 minutes"
  total: "2.5 hours"

browser_support:
  supported:
    - "Chrome 88+"
    - "Edge 88+"
    - "Opera 74+"
  partial_support:
    - "Safari (as Feature-Policy)"
  not_supported:
    - "Firefox (uses Feature-Policy)"
  fallback: "Use both Permissions-Policy and Feature-Policy headers"

notes: |
  Permissions-Policy is the successor to Feature-Policy. For maximum browser
  compatibility, both headers should be included:

  - Permissions-Policy: Modern browsers (Chrome 88+)
  - Feature-Policy: Older browsers and Firefox

  The middleware template includes both headers to ensure broad coverage.

  Common directives:
  - () = Feature disabled for all origins
  - (self) = Feature allowed for same origin only
  - (self "https://trusted.com") = Allow for self and specific origin
  - * = Feature allowed for all origins (not recommended)

  Integration with existing patterns:
  - Works alongside CSEC-28 (other security headers)
  - Complements Content-Security-Policy for defense-in-depth
  - Should be applied after SecurityMiddleware in middleware chain

example_header:
  permissions_policy: |
    Permissions-Policy: camera=(), microphone=(), geolocation=(),
    payment=(), usb=(), fullscreen=(self), picture-in-picture=(self)

  feature_policy: |
    Feature-Policy: camera 'none'; microphone 'none'; geolocation 'none';
    payment 'none'; usb 'none'; fullscreen 'self'; picture-in-picture 'self'
