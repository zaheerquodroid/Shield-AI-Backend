pattern_id: csec_28_security_headers
name: "Missing or Insecure Django Security Headers"
category: security_misconfiguration
severity: high
description: |
  Detects missing or insecure Django security header configurations in settings.py.
  Without proper security headers, applications are vulnerable to:
  - Clickjacking attacks (missing X-Frame-Options)
  - MIME sniffing attacks (missing X-Content-Type-Options)
  - Protocol downgrade attacks (missing HSTS)
  - Referrer leakage (missing Referrer-Policy)
  - Man-in-the-middle attacks (no SSL redirect)

jira_reference:
  ticket: CSEC-28
  epic: CSEC-5
  project: "Coco TestAI Security Remediation"

detection:
  # Python patterns for Django security headers
  python:
    - pattern: 'SECURE_HSTS_SECONDS\s*=\s*0'
      description: "HSTS disabled (set to 0)"
      example: "SECURE_HSTS_SECONDS = 0"
      severity: high

    - pattern: 'SECURE_HSTS_SECONDS\s*=\s*(?!31536000|[4-9]\d{7}|[1-9]\d{8,})\d+'
      description: "HSTS timeout too short (less than 1 year)"
      example: "SECURE_HSTS_SECONDS = 3600"
      severity: medium

    - pattern: 'SECURE_SSL_REDIRECT\s*=\s*False'
      description: "SSL redirect disabled"
      example: "SECURE_SSL_REDIRECT = False"
      severity: high

    - pattern: 'SECURE_CONTENT_TYPE_NOSNIFF\s*=\s*False'
      description: "Content-Type nosniff disabled"
      example: "SECURE_CONTENT_TYPE_NOSNIFF = False"
      severity: medium

    - pattern: 'X_FRAME_OPTIONS\s*=\s*["\']SAMEORIGIN["\']'
      description: "X-Frame-Options set to SAMEORIGIN (DENY is more secure)"
      example: "X_FRAME_OPTIONS = 'SAMEORIGIN'"
      severity: low

    - pattern: 'SESSION_COOKIE_SECURE\s*=\s*False'
      description: "Session cookies not marked as secure"
      example: "SESSION_COOKIE_SECURE = False"
      severity: medium

    - pattern: 'CSRF_COOKIE_SECURE\s*=\s*False'
      description: "CSRF cookies not marked as secure"
      example: "CSRF_COOKIE_SECURE = False"
      severity: medium

file_patterns:
  - "**/*settings*.py"      # Django settings files

risk_assessment:
  impact: high
  exploitability: medium
  affected_scope: entire_application
  labels:
    - P1-High
    - security
    - backend
    - extension-launch
    - wrapper

  vulnerabilities:
    - name: "Clickjacking"
      description: "Without X-Frame-Options: DENY, attackers can embed your site in iframes"
      cvss: "MEDIUM"

    - name: "MIME Sniffing"
      description: "Without Content-Type nosniff, browsers may execute malicious content"
      cvss: "MEDIUM"

    - name: "Protocol Downgrade"
      description: "Without HSTS, attackers can downgrade HTTPS to HTTP"
      cvss: "HIGH"

    - name: "Man-in-the-Middle"
      description: "Without SSL redirect, initial requests may be intercepted"
      cvss: "HIGH"

fix_strategy:
  approach: configuration_addition
  breaking_change: false
  description: "Add environment-aware security headers configuration block"

  implementation:
    - "Detect missing or insecure security header settings"
    - "Add comprehensive security headers block to settings.py"
    - "Make headers environment-aware (production vs development)"
    - "Set recommended values per OWASP guidelines"
    - "Generate .env.example with DJANGO_ENV variable"

acceptance_criteria:
  - "HSTS enabled with 1-year max-age in production"
  - "SSL redirect enabled in production"
  - "Content-Type nosniff enabled"
  - "Referrer-Policy set to strict-origin-when-cross-origin"
  - "X-Frame-Options set to DENY"
  - "All headers disabled in development"
  - "Environment-aware configuration (via DJANGO_ENV variable)"

security_headers_checklist:
  hsts:
    setting: "SECURE_HSTS_SECONDS"
    recommended: 31536000  # 1 year
    description: "HTTP Strict Transport Security"

  hsts_subdomains:
    setting: "SECURE_HSTS_INCLUDE_SUBDOMAINS"
    recommended: true
    description: "Apply HSTS to all subdomains"

  hsts_preload:
    setting: "SECURE_HSTS_PRELOAD"
    recommended: true
    description: "Allow HSTS preloading in browsers"

  ssl_redirect:
    setting: "SECURE_SSL_REDIRECT"
    recommended: true
    description: "Redirect all HTTP to HTTPS"

  content_type_nosniff:
    setting: "SECURE_CONTENT_TYPE_NOSNIFF"
    recommended: true
    description: "Prevent MIME type sniffing"

  referrer_policy:
    setting: "SECURE_REFERRER_POLICY"
    recommended: "strict-origin-when-cross-origin"
    description: "Control referrer information leakage"

  x_frame_options:
    setting: "X_FRAME_OPTIONS"
    recommended: "DENY"
    description: "Prevent clickjacking attacks"

  session_cookie_secure:
    setting: "SESSION_COOKIE_SECURE"
    recommended: true
    description: "Mark session cookies as secure"

  csrf_cookie_secure:
    setting: "CSRF_COOKIE_SECURE"
    recommended: true
    description: "Mark CSRF cookies as secure"

estimated_effort:
  detection: "5 minutes"
  fix_application: "30 minutes per codebase"
  verification: "1 hour (curl + Mozilla Observatory)"
  testing: "30 minutes"
  total: "3.5 hours per codebase"

testing:
  verification_commands:
    - "curl -I https://staging.example.com"
    - "Check for: Strict-Transport-Security, X-Content-Type-Options, X-Frame-Options, Referrer-Policy"

  mozilla_observatory:
    url: "https://observatory.mozilla.org/"
    target_grade: "A+"
    description: "Run Mozilla Observatory scan to verify all headers"

  security_headers_io:
    url: "https://securityheaders.com/"
    target_grade: "A"
    description: "Alternative security headers validation tool"

compliance:
  owasp:
    - "OWASP Top 10 A5:2021 - Security Misconfiguration"
    - "OWASP ASVS V14.4 - HTTP Security Headers"

  mozilla:
    - "Mozilla Web Security Guidelines - Security Headers"

  nist:
    - "NIST 800-53 SC-8 - Transmission Confidentiality"

references:
  - "https://docs.djangoproject.com/en/stable/ref/middleware/#module-django.middleware.security"
  - "https://observatory.mozilla.org/"
  - "https://owasp.org/www-project-secure-headers/"
  - "https://securityheaders.com/"
