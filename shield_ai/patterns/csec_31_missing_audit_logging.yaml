pattern_id: csec_31_missing_audit_logging
name: "Missing Audit Logging Infrastructure"
category: audit_logging
severity: high
description: |
  Detects Django applications that lack comprehensive audit logging infrastructure.

  Audit logging is essential for:
  - Compliance with regulatory requirements (PCI DSS, SOC 2, HIPAA, GDPR)
  - Security incident detection and investigation
  - Forensic analysis after security breaches
  - User activity monitoring and accountability
  - Insider threat detection

  Applications should log all security-relevant actions including authentication events,
  authorization failures, and data modifications with proper retention policies.

jira_reference:
  ticket: CSEC-31
  epic: CSEC-6
  project: "Coco TestAI Security Remediation"

detection:
  python:
    # Pattern 1: No AuditLog model
    - pattern: "class\\s+\\w+\\(models\\.Model\\):"
      description: "Models file without AuditLog model"
      example: |
        class User(models.Model):
            username = models.CharField(max_length=100)
      severity: high
      negative_lookahead: "(?:AuditLog|AuditTrail|SecurityLog|ActivityLog)"

    # Pattern 2: No audit logging utility
    - pattern: "^(?!.*log_audit|audit_log|log_security_event)"
      description: "No audit logging utility function found"
      example: "# utils.py without audit logging functions"
      severity: high
      file_pattern: "**/utils/*.py"

    # Pattern 3: Auth views without audit logging
    - pattern: "def\\s+login\\s*\\(|class\\s+\\w*Login\\w*View"
      description: "Login view without audit logging"
      example: |
        def login(request):
            user = authenticate(username=username, password=password)
            login(request, user)
      severity: high
      negative_lookahead: "(?:log_audit|audit_log|AuditLog\\.objects\\.create)"

file_patterns:
  - "**/models.py"
  - "**/models/*.py"
  - "**/utils/*.py"
  - "**/utils.py"
  - "**/views.py"
  - "**/views/*.py"
  - "**/auth/*.py"

risk_assessment:
  impact: high
  exploitability: n/a
  affected_scope: compliance_and_security_monitoring
  compliance_violations:
    - "PCI DSS Requirement 10 - Track and monitor all access to network resources"
    - "SOC 2 CC7.2 - Monitor system components and log activities"
    - "GDPR Article 30 - Records of processing activities"
    - "HIPAA ยง164.312(b) - Audit controls for ePHI access"
    - "ISO 27001 A.12.4.1 - Event logging requirements"
  security_implications:
    - "No audit trail for security incidents"
    - "Cannot detect or investigate security breaches"
    - "No forensic evidence for incident response"
    - "Cannot track unauthorized access"
    - "Insider threats undetectable"
    - "No user accountability"
  operational_risks:
    - "Compliance audit failures"
    - "Regulatory fines and penalties"
    - "Cannot prove security controls"
    - "No visibility into user actions"
    - "Incident response severely limited"
  labels:
    - P1-High
    - backend
    - security
    - compliance
    - extension-launch
    - wrapper

fix_strategy:
  approach: feature_addition
  breaking_change: false
  description: |
    Add comprehensive audit logging infrastructure including:

    1. AuditLog model with all required fields
    2. Audit logging utility functions
    3. Audit middleware for automatic logging
    4. Management commands for log retention
    5. Admin API for viewing and exporting logs
    6. Integration examples for auth and CRUD operations

    The implementation is non-breaking - existing code continues to work,
    and audit logging is added incrementally to critical paths.

  components:
    - component: audit_log_model
      name: "AuditLog Django Model"
      description: "Model to store audit trail with UUID, timestamp, user, action, resource, IP, user agent, details"
      files: ["models.py"]

    - component: audit_utility
      name: "Audit Logging Utility"
      description: "Helper function log_audit_event() for easy audit logging"
      files: ["utils/audit.py"]

    - component: audit_middleware
      name: "Audit Middleware"
      description: "Middleware to automatically log authenticated requests"
      files: ["middleware.py"]

    - component: management_commands
      name: "Management Commands"
      description: "cleanup_audit_logs command for 90-day retention"
      files: ["management/commands/cleanup_audit_logs.py"]

    - component: admin_api
      name: "Admin API"
      description: "API endpoints to list, filter, and export audit logs"
      files: ["views/audit.py", "serializers/audit.py", "urls.py"]

    - component: integration_examples
      name: "Integration Examples"
      description: "Examples of adding audit logging to auth views and CRUD operations"
      files: ["AUDIT_INTEGRATION.md"]

audit_events:
  authentication:
    - "login_success - User successfully logged in"
    - "login_failed - Failed login attempt"
    - "logout - User logged out"
    - "signup - New user registration"
    - "password_reset - Password reset requested"
    - "password_changed - Password successfully changed"
    - "mfa_enabled - Multi-factor authentication enabled"
    - "mfa_disabled - Multi-factor authentication disabled"
    - "session_revoked - Session manually revoked"

  authorization:
    - "permission_denied - User attempted unauthorized action"
    - "role_changed - User role or permissions modified"
    - "access_granted - Special access granted"

  data_operations:
    - "create - Resource created"
    - "update - Resource updated"
    - "delete - Resource deleted"
    - "bulk_delete - Multiple resources deleted"
    - "export - Data exported"
    - "import - Data imported"

  security:
    - "suspicious_activity - Suspicious behavior detected"
    - "rate_limit_exceeded - User hit rate limit"
    - "account_locked - Account locked due to failed attempts"
    - "account_unlocked - Account manually unlocked"
    - "user_impersonation - Admin impersonated user"

  system:
    - "configuration_changed - System configuration modified"
    - "admin_action - Administrative action performed"

audit_log_fields:
  required:
    - "id (UUID) - Unique identifier"
    - "timestamp (DateTime) - When action occurred"
    - "user_id (FK) - User who performed action (nullable for anonymous)"
    - "action (CharField) - Action type (login, create, update, delete, etc.)"
    - "resource_type (CharField) - Type of resource affected (nullable)"
    - "resource_id (CharField) - ID of resource affected (nullable)"
    - "ip_address (GenericIPAddressField) - Client IP address"
    - "user_agent (TextField) - Browser/client user agent"
    - "details (JSONField) - Additional context (before/after values, etc.)"

  optional:
    - "tenant_id (CharField) - For multi-tenant applications"
    - "session_id (CharField) - Session identifier"
    - "request_id (UUID) - Request correlation ID"
    - "success (Boolean) - Whether action succeeded"
    - "error_message (TextField) - Error if action failed"

retention_policy:
  default: "90 days"
  rationale: "Balance compliance requirements with storage costs"
  implementation: "Daily cron job or Celery beat task runs cleanup_audit_logs command"
  archival: "Export logs older than 90 days to S3/Glacier before deletion"

acceptance_criteria:
  - "AuditLog model exists with all required fields"
  - "All authentication events automatically logged"
  - "Data modification events logged (create/update/delete)"
  - "Audit logs include user, timestamp, IP, user agent, action, resource"
  - "Management command for 90-day retention cleanup"
  - "Admin API to list, filter, and export audit logs"
  - "JSON details field captures before/after values"
  - "No breaking changes to existing code"

estimated_effort:
  detection: "1 hour"
  model_creation: "3 hours (model + migration)"
  utility_functions: "2 hours (audit helpers)"
  middleware: "2 hours (auto-capture)"
  management_commands: "2 hours (cleanup + export)"
  admin_api: "4 hours (views + serializers + URLs)"
  integration_docs: "2 hours (examples and documentation)"
  testing: "3 hours (validate all components)"
  total: "19 hours per codebase"

compliance:
  - standard: "PCI DSS"
    requirement: "Requirement 10"
    description: "Track and monitor all access to network resources and cardholder data"

  - standard: "SOC 2"
    requirement: "CC7.2"
    description: "System operations - Monitor system components and log activities"

  - standard: "GDPR"
    requirement: "Article 30"
    description: "Records of processing activities - Maintain records of data processing"

  - standard: "HIPAA"
    requirement: "ยง164.312(b)"
    description: "Audit controls - Record and examine activity in systems with ePHI"

  - standard: "ISO 27001"
    requirement: "A.12.4.1"
    description: "Event logging - Record events, user activities, exceptions, faults"

  - standard: "NIST 800-53"
    requirement: "AU-2, AU-3, AU-6"
    description: "Audit events, content, review and analysis"

performance_considerations:
  - "Use async task queues (Celery) for audit logging to avoid blocking requests"
  - "Index frequently queried fields (user_id, action, timestamp, resource_type)"
  - "Partition tables by month for better query performance"
  - "Archive old logs to cold storage (S3 Glacier)"
  - "Use bulk_create() when logging multiple events"
  - "Consider separate audit database for isolation"

security_considerations:
  - "Audit logs are append-only (no updates or deletes except automated cleanup)"
  - "Audit log access restricted to admins only"
  - "Log modification attempts should themselves be audited"
  - "Encrypt sensitive data in details field"
  - "Separate audit log database credentials from application database"
  - "Monitor for gaps in audit logs (missing timestamps)"

example_queries:
  - query: "Find all failed login attempts for user"
    example: "AuditLog.objects.filter(user=user, action='login_failed')"

  - query: "Find all actions by IP address"
    example: "AuditLog.objects.filter(ip_address='192.168.1.100')"

  - query: "Find all data deletions in last 24 hours"
    example: "AuditLog.objects.filter(action='delete', timestamp__gte=yesterday)"

  - query: "Export audit logs for compliance audit"
    example: "AuditLog.objects.filter(timestamp__range=(start, end)).values()"

  - query: "Find all admin actions"
    example: "AuditLog.objects.filter(action='admin_action')"

integration_points:
  authentication:
    - "Login view - Log login_success with IP and user agent"
    - "Login view - Log login_failed with attempted username"
    - "Logout view - Log logout"
    - "Signup view - Log signup with email"
    - "Password reset view - Log password_reset"

  authorization:
    - "Permission decorators - Log permission_denied"
    - "Role change views - Log role_changed with before/after"

  crud_operations:
    - "Create views - Log create with resource details"
    - "Update views - Log update with before/after in details"
    - "Delete views - Log delete with resource snapshot"
    - "Bulk operations - Log bulk_delete with count"

references:
  - "https://owasp.org/www-community/controls/Audit_Logging"
  - "https://www.pcisecuritystandards.org/document_library (PCI DSS Requirement 10)"
  - "https://gdpr-info.eu/art-30-gdpr/"
  - "https://www.hhs.gov/hipaa/for-professionals/security/laws-regulations/index.html"
  - "https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r5.pdf"
