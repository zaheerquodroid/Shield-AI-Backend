pattern_id: csec_27_missing_pwned_check
name: "Missing Breached Password Validation"
category: authentication_security
severity: high
description: |
  Detects Django applications that lack password breach checking against known
  compromised passwords. Users can set passwords that have been exposed in data
  breaches, making accounts vulnerable to credential stuffing attacks.

  Best practice: Check passwords against Have I Been Pwned (HIBP) API using
  k-anonymity to protect user privacy while preventing use of breached passwords.

jira_reference:
  ticket: CSEC-27
  epic: CSEC-4
  project: "Coco TestAI Security Remediation"

detection:
  python:
    # Pattern 1: AUTH_PASSWORD_VALIDATORS exists but no pwned/breach checking
    - pattern: "AUTH_PASSWORD_VALIDATORS\\s*=\\s*\\[([^\\]]+)\\]"
      description: "AUTH_PASSWORD_VALIDATORS without breach password checking"
      example: |
        AUTH_PASSWORD_VALIDATORS = [
            {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
        ]
      severity: high
      negative_lookahead: "(?:pwned|hibp|breach|Pwned|HIBP|Breach)"

    # Pattern 2: No AUTH_PASSWORD_VALIDATORS at all (detect by file having Django imports but no validators)
    - pattern: "from django\\.contrib\\.auth"
      description: "Django auth imported but no AUTH_PASSWORD_VALIDATORS configured"
      example: "from django.contrib.auth import authenticate"
      severity: medium
      context_check: "no_password_validators"

file_patterns:
  - "**/settings.py"
  - "**/settings/*.py"
  - "**/*settings*.py"

risk_assessment:
  impact: high
  exploitability: high
  affected_scope: authentication_system
  attack_vectors:
    - "Credential stuffing attacks"
    - "Password reuse exploitation"
    - "Brute force with known breached passwords"
    - "Account takeover"
  vulnerabilities:
    - "Users can set passwords from known breaches"
    - "No warning about compromised passwords"
    - "Increased risk of account compromise"
  labels:
    - P0-Critical
    - authentication
    - security
    - backend
    - extension-launch

fix_strategy:
  approach: configuration_addition
  breaking_change: false
  description: |
    Add password breach checking to Django settings using one of:
    1. django-pwned-passwords library (recommended)
    2. Custom HIBP k-anonymity validator

    The fix is non-breaking and advisory - warns users but doesn't block signup.

  implementation_options:
    - option: library
      name: "django-pwned-passwords"
      pros: "Battle-tested, k-anonymity built-in, caching support"
      cons: "External dependency"

    - option: custom
      name: "Custom HIBP validator"
      pros: "No dependencies, full control"
      cons: "More code to maintain"

acceptance_criteria:
  - "Password checked against HaveIBeenPwned API using k-anonymity"
  - "Warning shown if password found in breaches (advisory, not blocking)"
  - "AUTH_PASSWORD_VALIDATORS includes breach checking validator"
  - "Privacy protected via k-anonymity (only first 5 chars of hash sent)"
  - "Graceful degradation if HIBP API unavailable"

estimated_effort:
  detection: "5 minutes"
  fix_application: "2 hours (including validator setup)"
  testing: "1 hour"
  total: "3 hours per codebase"

compliance:
  - standard: "NIST 800-63B"
    requirement: "Section 5.1.1.2 - Memorized Secret Verifiers"
    description: "Check passwords against known breach databases"

  - standard: "OWASP ASVS"
    requirement: "V2.1.7"
    description: "Verify passwords are checked against breached password lists"

references:
  - "https://haveibeenpwned.com/API/v3"
  - "https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/"
  - "https://django-pwned-passwords.readthedocs.io/"
  - "https://pages.nist.gov/800-63-3/sp800-63b.html"
  - "https://owasp.org/www-project-application-security-verification-standard/"
